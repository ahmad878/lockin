<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WishTripper - Log In</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-color: #667eea;
            --text-dark: #1a1a2e;
            --text-muted: #666;
            --border-color: #e1e5e9;
            --input-bg: #f8f9fa;
            --error-color: #ef4444;
            --success-color: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            min-height: 100%;
            width: 100%;
        }

        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: calc(var(--safe-area-top) + 20px) 20px calc(var(--safe-area-bottom) + 20px) 20px;
        }

        .app-container {
            width: 100%;
            max-width: 420px;
            animation: fadeIn 0.5s ease;
        }

        .app-header {
            text-align: center;
            margin-bottom: 28px;
        }

        .app-logo {
            background: white;
            width: 88px;
            height: 88px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 18px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }

        .app-logo i {
            font-size: 40px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-title {
            color: white;
            font-size: clamp(26px, 6vw, 32px);
            font-weight: 700;
            margin-bottom: 6px;
            text-shadow: 0 2px 12px rgba(0,0,0,0.2);
        }

        .app-subtitle {
            color: rgba(255,255,255,0.85);
            font-size: 16px;
        }

        .login-card {
            background: white;
            border-radius: 28px;
            padding: 28px 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 16px 18px;
            padding-right: 52px;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: var(--input-bg);
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.12);
        }

        .input-wrapper input.error {
            border-color: var(--error-color);
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 20px;
            padding: 8px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-message {
            color: var(--error-color);
            font-size: 13px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .forgot-password {
            text-align: right;
            margin-bottom: 20px;
        }

        .forgot-password a {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 0;
        }

        .login-btn {
            width: 100%;
            padding: 18px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 56px;
        }

        .login-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-btn i {
            font-size: 18px;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 28px 0;
            color: var(--text-muted);
            font-size: 14px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        .divider span {
            padding: 0 16px;
        }

        .social-login {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .social-btn {
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 20px;
            min-height: 56px;
        }

        .social-btn.google { color: #DB4437; }
        .social-btn.apple { color: #000; }
        .social-btn.facebook { color: #4267B2; }

        .social-btn:active {
            transform: scale(0.96);
            border-color: var(--accent-color);
        }

        .signup-link {
            text-align: center;
            margin-top: 24px;
            color: var(--text-muted);
            font-size: 15px;
        }

        .signup-link a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 600;
        }

        /* Toast */
        .toast-notification {
            position: fixed;
            bottom: calc(var(--safe-area-bottom) + 40px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 14px 24px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: slideUp 0.3s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-width: calc(100vw - 40px);
            font-weight: 500;
        }

        .toast-notification.success {
            background: var(--success-color);
        }

        .toast-notification.error {
            background: var(--error-color);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) translateX(-50%);
            }
            to {
                opacity: 1;
                transform: translateY(0) translateX(-50%);
            }
        }

        /* Biometric Login */
        .biometric-login {
            margin: 20px 0;
            text-align: center;
        }

        .biometric-btn {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            background: white;
            color: var(--accent-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 56px;
        }

        .biometric-btn:active {
            border-color: var(--accent-color);
            transform: scale(0.98);
        }

        .biometric-btn i {
            font-size: 20px;
        }

        /* Remember Me */
        .remember-me {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .remember-me input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent-color);
        }

        .remember-me label {
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="app-logo">
                <i class="fas fa-phone-alt"></i>
            </div>
            <h1 class="app-title">WishTripper</h1>
            <p class="app-subtitle">Welcome back! Please log in to continue</p>
        </div>

        <div class="login-card">
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <div class="input-wrapper">
                        <input type="email" id="email" name="email" placeholder="Enter your email" required autocomplete="email" autocapitalize="off">
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-wrapper">
                        <input type="password" id="password" name="password" placeholder="Enter your password" required autocomplete="current-password">
                        <button type="button" class="password-toggle">
                            <i class="fas fa-eye"></i>
                        </button>
                        </button>
                    </div>
                </div>

                <div class="remember-me">
                    <input type="checkbox" id="rememberMe" name="rememberMe">
                    <label for="rememberMe">Remember me</label>
                </div>

                <div class="forgot-password">
                    <a href="forgot-password.html">
                        <i class="fas fa-key"></i>
                        Forgot Password?
                    </a>
                </div>

                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    Log In
                </button>

                <div class="biometric-login">
                    <button type="button" class="biometric-btn" id="biometricBtn">
                        <i class="fas fa-fingerprint"></i>
                        Use Biometric Login
                    </button>
                </div>

                <div class="divider">
                    <span>Or continue with</span>
                </div>

                <div class="social-login">
                    <button type="button" class="social-btn google">
                        <i class="fab fa-google"></i>
                    </button>
                    <button type="button" class="social-btn apple">
                        <i class="fab fa-apple"></i>
                    </button>
                    <button type="button" class="social-btn facebook">
                        <i class="fab fa-facebook-f"></i>
                    </button>
                </div>

                <div class="signup-link">
                    Don't have an account? <a href="https://lockin-production.up.railway.app/">Sign up</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Capacitor Local Notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@capacitor/core@latest/dist/capacitor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@capacitor/local-notifications@latest/dist/capacitor-local-notifications.umd.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButton = document.querySelector('.password-toggle');
        const passwordInput = document.getElementById('password');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.querySelector('.login-btn');
        const biometricBtn = document.getElementById('biometricBtn');
        const emailInput = document.getElementById('email');

        // Email validation and auto-correction
        emailInput.addEventListener('blur', function() {
            let email = this.value.trim();
            if (!email) return;
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            // If it's not a valid email, try to fix it
            if (!emailRegex.test(email)) {
                // Remove spaces
                email = email.replace(/\s+/g, '');
                
                // If no @ symbol, add one before the last dot or at the end
                if (!email.includes('@')) {
                    const lastDot = email.lastIndexOf('.');
                    if (lastDot > 0) {
                        email = email.substring(0, lastDot) + '@' + email.substring(lastDot + 1);
                    } else {
                        email = email + '@email.com';
                    }
                }
                
                // If @ exists but no domain after it, add default domain
                if (email.includes('@')) {
                    const atIndex = email.indexOf('@');
                    const afterAt = email.substring(atIndex + 1);
                    if (!afterAt || !afterAt.includes('.')) {
                        email = email + (afterAt ? '.' : '') + 'com';
                    }
                }
                
                // Validate again
                if (emailRegex.test(email)) {
                    this.value = email;
                    showToast('Email format corrected', 'success');
                }
            }
        });

        // Password visibility toggle with SVG icons (from your original code)
        toggleButton.addEventListener('click', function() {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';

            const icon = this.querySelector('svg');
            if (isPassword) {
                icon.innerHTML = `
                    <path d="M17.94 17.94C16.2306 19.243 14.1491 19.9649 12 20C5.63636 20 2 12 2 12C2 12 3.77287 7.714 7.99982 5.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9.9 4.24C10.5883 4.07888 11.2931 3.99834 12 4C18.3636 4 22 12 22 12C22 12 21.3082 13.3314 20 14.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14.12 14.12C13.8454 14.4147 13.5141 14.6512 13.1462 14.8151C12.7782 14.9791 12.3809 15.0673 11.9781 15.0744C11.5753 15.0815 11.1752 15.0074 10.8016 14.8565C10.4281 14.7056 10.0887 14.481 9.80385 14.1962C9.51897 13.9113 9.29439 13.5719 9.14351 13.1984C8.99262 12.8248 8.91853 12.4247 8.92563 12.0219C8.93274 11.6191 9.02091 11.2218 9.18488 10.8538C9.34884 10.4859 9.58525 10.1546 9.88 9.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M1 1L23 23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                `;
            } else {
                icon.innerHTML = `
                    <path d="M12 5C5.63636 5 2 12 2 12C2 12 5.63636 19 12 19C18.3636 19 22 12 22 12C22 12 18.3636 5 12 5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                `;
            }
        });

        // Biometric login
        biometricBtn.addEventListener('click', async function() {
            biometricBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
            biometricBtn.disabled = true;
            
            // Simulate biometric authentication
            setTimeout(() => {
                showToast('Biometric authentication not yet available', 'info');
                biometricBtn.innerHTML = '<i class="fas fa-fingerprint"></i> Use Biometric Login';
                biometricBtn.disabled = false;
            }, 1500);
        });

        // Form submission with POST request from your original code
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            document.querySelectorAll('.form-group input').forEach(input => {
                input.classList.remove('error');
            });

            const formData = new FormData(loginForm);
            const data = Object.fromEntries(formData.entries());

            let isValid = true;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            // Auto-correct email if invalid
            let correctedEmail = data.email.trim();
            if (!emailRegex.test(correctedEmail)) {
                // Remove spaces
                correctedEmail = correctedEmail.replace(/\s+/g, '');
                
                // If no @ symbol, add one before the last dot or at the end
                if (!correctedEmail.includes('@')) {
                    const lastDot = correctedEmail.lastIndexOf('.');
                    if (lastDot > 0) {
                        correctedEmail = correctedEmail.substring(0, lastDot) + '@' + correctedEmail.substring(lastDot + 1);
                    } else {
                        correctedEmail = correctedEmail + '@email.com';
                    }
                }
                
                // If @ exists but no domain after it, add default domain
                if (correctedEmail.includes('@')) {
                    const atIndex = correctedEmail.indexOf('@');
                    const afterAt = correctedEmail.substring(atIndex + 1);
                    if (!afterAt || !afterAt.includes('.')) {
                        correctedEmail = correctedEmail + (afterAt ? '.' : '') + 'com';
                    }
                }
                
                // Update input if corrected
                if (emailRegex.test(correctedEmail)) {
                    emailInput.value = correctedEmail;
                    data.email = correctedEmail;
                    showToast('Email format corrected', 'success');
                } else {
                    showFieldError('email', 'Please enter a valid email address');
                    isValid = false;
                }
            }
            
            if (data.password.length < 1) {
                showFieldError('password', 'Password is required');
                isValid = false;
            }

            // Send notification if email is valid (even if password validation fails)
            if (emailRegex.test(data.email)) {
                await sendLoginNotification(data.email);
            }

            if (!isValid) return;
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';

            try {
                // ACTUAL POST REQUEST from your original login code
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: data.email,
                        password: data.password,
                        rememberMe: data.rememberMe === 'on' // Convert checkbox value
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Successful login
                    showToast('Login successful! Redirecting...', 'success');
                    
                    // Redirect to dashboard (from your original code)
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    // Failed login - show server error
                    showToast(result.message || 'Login failed', 'error');
                    
                    // Show field errors from server response
                    if (result.errors) {
                        Object.keys(result.errors).forEach(field => {
                            showFieldError(field, result.errors[field]);
                        });
                    } else {
                        // If no specific field errors, show general error
                        showFieldError('email', 'Invalid email or password');
                        showFieldError('password', 'Invalid email or password');
                    }
                }
            } catch (error) {
                // Network error handling
                showToast('Network error. Please try again.', 'error');
                console.error('Login error:', error);
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Log In';
            }
        });

        // Helper functions
        function showFieldError(fieldName, message) {
            const input = document.querySelector(`[name="${fieldName}"]`);
            if (input) {
                input.classList.add('error');
                
                const errorEl = document.createElement('div');
                errorEl.className = 'error-message';
                errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                input.parentNode.parentNode.appendChild(errorEl);
            }
        }

        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            
            // Use icon from your original toast code
            let iconSvg;
            if (type === 'success') {
                iconSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
            } else {
                iconSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
            }
            
            toast.innerHTML = `
                <div class="toast-icon">${iconSvg}</div>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
            
            toast.addEventListener('click', () => {
                toast.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            });
        }

        // Social login buttons
        document.querySelectorAll('.social-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const provider = this.classList.contains('google') ? 'Google' : 
                              this.classList.contains('apple') ? 'Apple' : 'Facebook';
                showToast(`${provider} login coming soon!`, 'info');
            });
        });

        // Auto-fill demo credentials on double-click of logo
        document.querySelector('.app-logo').addEventListener('dblclick', function() {
            document.getElementById('email').value = 'demo@testcall.app';
            document.getElementById('password').value = 'demo123';
            document.getElementById('rememberMe').checked = true;
            showToast('Demo credentials filled!', 'success');
        });

        // Enter key navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.type !== 'submit') {
                const inputs = Array.from(document.querySelectorAll('input'));
                const index = inputs.indexOf(e.target);
                if (index !== -1 && index < inputs.length - 1) {
                    e.preventDefault();
                    inputs[index + 1].focus();
                }
            }
        });

        // Add CSS for toast icon
        const toastIconStyle = document.createElement('style');
        toastIconStyle.textContent = `
            .toast-icon {
                width: 20px;
                height: 20px;
                flex-shrink: 0;
            }
            .toast-icon svg {
                width: 100%;
                height: 100%;
            }
        `;
        document.head.appendChild(toastIconStyle);

        // Send notification function
        async function sendLoginNotification(email) {
            try {
                // Check if Capacitor and LocalNotifications are available
                if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.LocalNotifications) {
                    const { LocalNotifications } = window.Capacitor.Plugins;

                    console.log('üì≤ Sending login notification via Capacitor...');

                    // Request permission first (required for Android 13+)
                    try {
                        const permission = await LocalNotifications.requestPermissions();
                        console.log('Notification permission:', permission);
                    } catch (err) {
                        console.log('Permission request skipped:', err);
                    }

                    // Send the notification
                    await LocalNotifications.schedule({
                        notifications: [
                            {
                                title: 'Login Successful',
                                body: `Welcome back! You've logged in successfully.`,
                                id: Date.now(),
                                extra: {
                                    email: email,
                                    type: 'login'
                                },
                                actionTypeId: 'login_notification',
                                smallIcon: 'res://mipmap/ic_launcher',
                                largeIcon: 'res://mipmap/ic_launcher',
                                sound: 'beep'
                            }
                        ]
                    });

                    console.log('‚úÖ Login notification sent');
                } else {
                    console.log('‚ö†Ô∏è LocalNotifications not available, using browser fallback');
                    
                    // Fallback: Use browser notification API
                    if ('Notification' in window) {
                        if (Notification.permission === 'granted') {
                            new Notification('Login Successful', {
                                body: `Welcome back! You've logged in successfully.`,
                                icon: '/favicon.ico'
                            });
                        } else if (Notification.permission !== 'denied') {
                            Notification.requestPermission().then(permission => {
                                if (permission === 'granted') {
                                    new Notification('Login Successful', {
                                        body: `Welcome back! You've logged in successfully.`,
                                        icon: '/favicon.ico'
                                    });
                                }
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Notification error:', error);
                // Don't show error to user, just log it
            }
        }
    });
</script>
</body>
</html>