<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#111b21">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BitChatly - Log In</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --primary-bg: #111b21;
            --secondary-bg: #1f2c34;
            --tertiary-bg: #202c33;
            --accent-color: #00a884;
            --accent-hover: #008c6e;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --border-color: #233138;
            --error-color: #ef4444;
            --success-color: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            min-height: 100%;
            width: 100%;
            background: var(--primary-bg);
        }

        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: calc(var(--safe-area-top) + 20px) 20px calc(var(--safe-area-bottom) + 20px) 20px;
        }

        .app-container {
            width: 100%;
            max-width: 420px;
            animation: fadeIn 0.5s ease;
        }

        .app-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .app-logo {
            background: var(--accent-color);
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 8px 24px rgba(0, 168, 132, 0.3);
        }

        .app-logo i {
            font-size: 36px;
            color: white;
        }

        .app-title {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .app-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .login-card {
            background: var(--secondary-bg);
            border-radius: 20px;
            padding: 28px 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 14px 16px;
            padding-right: 50px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: var(--tertiary-bg);
            color: var(--text-primary);
        }

        .input-wrapper input::placeholder {
            color: var(--text-secondary);
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 168, 132, 0.1);
        }

        .input-wrapper input.error {
            border-color: var(--error-color);
        }

        .input-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 18px;
            pointer-events: none;
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            transition: color 0.2s;
        }

        .password-toggle:hover {
            color: var(--accent-color);
        }

        .error-message {
            color: var(--error-color);
            font-size: 13px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .options-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
            cursor: pointer;
        }

        .remember-me label {
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }

        .forgot-password a {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: color 0.2s;
        }

        .forgot-password a:hover {
            color: var(--accent-hover);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 52px;
        }

        .login-btn:hover {
            background: var(--accent-hover);
        }

        .login-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        .divider span {
            padding: 0 16px;
        }

        .biometric-btn {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: transparent;
            color: var(--accent-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 50px;
            font-size: 15px;
        }

        .biometric-btn:hover {
            border-color: var(--accent-color);
            background: rgba(0, 168, 132, 0.05);
        }

        .biometric-btn:active {
            transform: scale(0.98);
        }

        .biometric-btn i {
            font-size: 20px;
        }

        .signup-link {
            text-align: center;
            margin-top: 24px;
            color: var(--text-secondary);
            font-size: 15px;
        }

        .signup-link a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }

        .signup-link a:hover {
            color: var(--accent-hover);
        }

        /* Toast */
        .toast-notification {
            position: fixed;
            bottom: calc(var(--safe-area-bottom) + 20px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary-bg);
            color: var(--text-primary);
            padding: 14px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: slideUp 0.3s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            max-width: calc(100vw - 40px);
            font-weight: 500;
            border: 1px solid var(--border-color);
        }

        .toast-notification.success {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .toast-notification.error {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) translateX(-50%);
            }
            to {
                opacity: 1;
                transform: translateY(0) translateX(-50%);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0) translateX(-50%);
            }
            to {
                opacity: 0;
                transform: translateY(-10px) translateX(-50%);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        /* Responsive */
        @media (max-width: 480px) {
            body {
                padding: calc(var(--safe-area-top) + 10px) 16px calc(var(--safe-area-bottom) + 10px) 16px;
            }

            .login-card {
                padding: 24px 20px;
                border-radius: 16px;
            }

            .app-logo {
                width: 70px;
                height: 70px;
            }

            .app-logo i {
                font-size: 32px;
            }

            .app-title {
                font-size: 24px;
            }

            .options-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .forgot-password {
                order: -1;
                align-self: flex-end;
            }
        }

        /* iOS Specific Fixes */
        @supports (-webkit-touch-callout: none) {
            input {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="app-logo">
                <i class="fas fa-comments"></i>
            </div>
            <h1 class="app-title">Welcome Back</h1>
            <p class="app-subtitle">Sign in to continue to BitChatly</p>
        </div>

        <div class="login-card">
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <div class="input-wrapper">
                        <input type="email" id="email" name="email" placeholder="Enter your email" required autocomplete="email" autocapitalize="off">
                        <i class="fas fa-envelope input-icon"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-wrapper">
                        <input type="password" id="password" name="password" placeholder="Enter your password" required autocomplete="current-password">
                        <button type="button" class="password-toggle" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="options-row">
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <label for="rememberMe">Remember me</label>
                    </div>

                    <div class="forgot-password">
                        <a href="forgot-password.html">Forgot Password?</a>
                    </div>
                </div>

                <button type="submit" class="login-btn" id="loginBtn">
                    <span>Sign In</span>
                    <i class="fas fa-arrow-right"></i>
                </button>

                <div class="divider">
                    <span>or</span>
                </div>

                <button type="button" class="biometric-btn" id="biometricBtn">
                    <i class="fas fa-fingerprint"></i>
                    <span>Use Biometric Login</span>
                </button>

                <div class="signup-link">
                    Don't have an account? <a href="/signup.html">Sign Up</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Capacitor Local Notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@capacitor/core@latest/dist/capacitor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@capacitor/local-notifications@latest/dist/capacitor-local-notifications.umd.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleButton = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            const loginForm = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            const biometricBtn = document.getElementById('biometricBtn');
            const emailInput = document.getElementById('email');

            // Password Toggle
            toggleButton.addEventListener('click', function() {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                this.querySelector('i').className = isPassword ? 'fas fa-eye-slash' : 'fas fa-eye';
            });

            // Email validation and auto-correction
            emailInput.addEventListener('blur', function() {
                let email = this.value.trim();
                if (!email) return;
                
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!emailRegex.test(email)) {
                    email = email.replace(/\s+/g, '');
                    
                    if (!email.includes('@')) {
                        const lastDot = email.lastIndexOf('.');
                        if (lastDot > 0) {
                            email = email.substring(0, lastDot) + '@' + email.substring(lastDot + 1);
                        } else {
                            email = email + '@email.com';
                        }
                    }
                    
                    if (email.includes('@')) {
                        const atIndex = email.indexOf('@');
                        const afterAt = email.substring(atIndex + 1);
                        if (!afterAt || !afterAt.includes('.')) {
                            email = email + (afterAt ? '.' : '') + 'com';
                        }
                    }
                    
                    if (emailRegex.test(email)) {
                        this.value = email;
                        showToast('Email format corrected', 'success');
                    }
                }
            });

            // Biometric Login
            biometricBtn.addEventListener('click', async function() {
                const originalContent = biometricBtn.innerHTML;
                biometricBtn.innerHTML = '<div class="spinner"></div><span>Authenticating...</span>';
                biometricBtn.disabled = true;
                
                setTimeout(() => {
                    showToast('Biometric authentication not yet available', 'error');
                    biometricBtn.innerHTML = originalContent;
                    biometricBtn.disabled = false;
                }, 1500);
            });

            // Form Submission
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Clear previous errors
                document.querySelectorAll('.error-message').forEach(el => el.remove());
                document.querySelectorAll('.form-group input').forEach(input => {
                    input.classList.remove('error');
                });

                const formData = new FormData(loginForm);
                const data = Object.fromEntries(formData.entries());

                let isValid = true;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                // Auto-correct email if invalid
                let correctedEmail = data.email.trim();
                if (!emailRegex.test(correctedEmail)) {
                    correctedEmail = correctedEmail.replace(/\s+/g, '');
                    
                    if (!correctedEmail.includes('@')) {
                        const lastDot = correctedEmail.lastIndexOf('.');
                        if (lastDot > 0) {
                            correctedEmail = correctedEmail.substring(0, lastDot) + '@' + correctedEmail.substring(lastDot + 1);
                        } else {
                            correctedEmail = correctedEmail + '@email.com';
                        }
                    }
                    
                    if (correctedEmail.includes('@')) {
                        const atIndex = correctedEmail.indexOf('@');
                        const afterAt = correctedEmail.substring(atIndex + 1);
                        if (!afterAt || !afterAt.includes('.')) {
                            correctedEmail = correctedEmail + (afterAt ? '.' : '') + 'com';
                        }
                    }
                    
                    if (emailRegex.test(correctedEmail)) {
                        emailInput.value = correctedEmail;
                        data.email = correctedEmail;
                        showToast('Email format corrected', 'success');
                    } else {
                        showFieldError('email', 'Please enter a valid email address');
                        isValid = false;
                    }
                }
                
                if (data.password.length < 1) {
                    showFieldError('password', 'Password is required');
                    isValid = false;
                }

                // Send notification if email is valid
                if (emailRegex.test(data.email)) {
                    await sendLoginNotification(data.email);
                }

                if (!isValid) return;
                
                // Show loading state
                loginBtn.disabled = true;
                const originalContent = loginBtn.innerHTML;
                loginBtn.innerHTML = '<div class="spinner"></div><span>Signing In...</span>';

                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: data.email,
                            password: data.password,
                            rememberMe: data.rememberMe === 'on'
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showToast('Login successful! Redirecting...', 'success');
                        
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1000);
                    } else {
                        showToast(result.message || 'Login failed', 'error');
                        
                        if (result.errors) {
                            Object.keys(result.errors).forEach(field => {
                                showFieldError(field, result.errors[field]);
                            });
                        } else {
                            showFieldError('email', 'Invalid email or password');
                            showFieldError('password', 'Invalid email or password');
                        }
                    }
                } catch (error) {
                    showToast('Network error. Please try again.', 'error');
                    console.error('Login error:', error);
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = originalContent;
                }
            });

            // Helper Functions
            function showFieldError(fieldName, message) {
                const input = document.querySelector(`[name="${fieldName}"]`);
                if (input) {
                    input.classList.add('error');
                    
                    const errorEl = document.createElement('div');
                    errorEl.className = 'error-message';
                    errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                    input.parentNode.parentNode.appendChild(errorEl);
                }
            }

            function showToast(message, type = 'info') {
                const existingToast = document.querySelector('.toast-notification');
                if (existingToast) existingToast.remove();
                
                const toast = document.createElement('div');
                toast.className = `toast-notification ${type}`;
                toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> <span>${message}</span>`;
                
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
                
                toast.addEventListener('click', () => {
                    toast.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                });
            }

            // Auto-fill demo credentials on double-click of logo
            document.querySelector('.app-logo').addEventListener('dblclick', function() {
                document.getElementById('email').value = 'demo@testcall.app';
                document.getElementById('password').value = 'demo123';
                document.getElementById('rememberMe').checked = true;
                showToast('Demo credentials filled!', 'success');
            });

            // Enter key navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.type !== 'submit') {
                    const inputs = Array.from(document.querySelectorAll('input'));
                    const index = inputs.indexOf(e.target);
                    if (index !== -1 && index < inputs.length - 1) {
                        e.preventDefault();
                        inputs[index + 1].focus();
                    }
                }
            });

            // Send notification function
            async function sendLoginNotification(email) {
                try {
                    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.LocalNotifications) {
                        const { LocalNotifications } = window.Capacitor.Plugins;

                        console.log('üì≤ Sending login notification via Capacitor...');

                        try {
                            const permission = await LocalNotifications.requestPermissions();
                            console.log('Notification permission:', permission);
                        } catch (err) {
                            console.log('Permission request skipped:', err);
                        }

                        await LocalNotifications.schedule({
                            notifications: [
                                {
                                    title: 'Login Successful',
                                    body: `Welcome back! You've logged in successfully.`,
                                    id: Date.now(),
                                    extra: {
                                        email: email,
                                        type: 'login'
                                    },
                                    actionTypeId: 'login_notification',
                                    smallIcon: 'res://mipmap/ic_launcher',
                                    largeIcon: 'res://mipmap/ic_launcher',
                                    sound: 'beep'
                                }
                            ]
                        });

                        console.log('‚úÖ Login notification sent');
                    } else {
                        console.log('‚ö†Ô∏è LocalNotifications not available, using browser fallback');
                        
                        if ('Notification' in window) {
                            if (Notification.permission === 'granted') {
                                new Notification('Login Successful', {
                                    body: `Welcome back! You've logged in successfully.`,
                                    icon: '/favicon.ico'
                                });
                            } else if (Notification.permission !== 'denied') {
                                Notification.requestPermission().then(permission => {
                                    if (permission === 'granted') {
                                        new Notification('Login Successful', {
                                            body: `Welcome back! You've logged in successfully.`,
                                            icon: '/favicon.ico'
                                        });
                                    }
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Notification error:', error);
                }
            }
        });
    </script>
</body>
</html>
        const toggleButton = document.querySelector('.password-toggle');
        const passwordInput = document.getElementById('password');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.querySelector('.login-btn');
        const biometricBtn = document.getElementById('biometricBtn');
        const emailInput = document.getElementById('email');

        // Email validation and auto-correction
        emailInput.addEventListener('blur', function() {
            let email = this.value.trim();
            if (!email) return;
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            // If it's not a valid email, try to fix it
            if (!emailRegex.test(email)) {
                // Remove spaces
                email = email.replace(/\s+/g, '');
                
                // If no @ symbol, add one before the last dot or at the end
                if (!email.includes('@')) {
                    const lastDot = email.lastIndexOf('.');
                    if (lastDot > 0) {
                        email = email.substring(0, lastDot) + '@' + email.substring(lastDot + 1);
                    } else {
                        email = email + '@email.com';
                    }
                }
                
                // If @ exists but no domain after it, add default domain
                if (email.includes('@')) {
                    const atIndex = email.indexOf('@');
                    const afterAt = email.substring(atIndex + 1);
                    if (!afterAt || !afterAt.includes('.')) {
                        email = email + (afterAt ? '.' : '') + 'com';
                    }
                }
                
                // Validate again
                if (emailRegex.test(email)) {
                    this.value = email;
                    showToast('Email format corrected', 'success');
                }
            }
        });

        // Password visibility toggle with SVG icons (from your original code)
        toggleButton.addEventListener('click', function() {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';

            const icon = this.querySelector('svg');
            if (isPassword) {
                icon.innerHTML = `
                    <path d="M17.94 17.94C16.2306 19.243 14.1491 19.9649 12 20C5.63636 20 2 12 2 12C2 12 3.77287 7.714 7.99982 5.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9.9 4.24C10.5883 4.07888 11.2931 3.99834 12 4C18.3636 4 22 12 22 12C22 12 21.3082 13.3314 20 14.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14.12 14.12C13.8454 14.4147 13.5141 14.6512 13.1462 14.8151C12.7782 14.9791 12.3809 15.0673 11.9781 15.0744C11.5753 15.0815 11.1752 15.0074 10.8016 14.8565C10.4281 14.7056 10.0887 14.481 9.80385 14.1962C9.51897 13.9113 9.29439 13.5719 9.14351 13.1984C8.99262 12.8248 8.91853 12.4247 8.92563 12.0219C8.93274 11.6191 9.02091 11.2218 9.18488 10.8538C9.34884 10.4859 9.58525 10.1546 9.88 9.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M1 1L23 23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                `;
            } else {
                icon.innerHTML = `
                    <path d="M12 5C5.63636 5 2 12 2 12C2 12 5.63636 19 12 19C18.3636 19 22 12 22 12C22 12 18.3636 5 12 5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                `;
            }
        });

        // Biometric login
        biometricBtn.addEventListener('click', async function() {
            biometricBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
            biometricBtn.disabled = true;
            
            // Simulate biometric authentication
            setTimeout(() => {
                showToast('Biometric authentication not yet available', 'info');
                biometricBtn.innerHTML = '<i class="fas fa-fingerprint"></i> Use Biometric Login';
                biometricBtn.disabled = false;
            }, 1500);
        });

        // Form submission with POST request from your original code
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            document.querySelectorAll('.form-group input').forEach(input => {
                input.classList.remove('error');
            });

            const formData = new FormData(loginForm);
            const data = Object.fromEntries(formData.entries());

            let isValid = true;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            // Auto-correct email if invalid
            let correctedEmail = data.email.trim();
            if (!emailRegex.test(correctedEmail)) {
                // Remove spaces
                correctedEmail = correctedEmail.replace(/\s+/g, '');
                
                // If no @ symbol, add one before the last dot or at the end
                if (!correctedEmail.includes('@')) {
                    const lastDot = correctedEmail.lastIndexOf('.');
                    if (lastDot > 0) {
                        correctedEmail = correctedEmail.substring(0, lastDot) + '@' + correctedEmail.substring(lastDot + 1);
                    } else {
                        correctedEmail = correctedEmail + '@email.com';
                    }
                }
                
                // If @ exists but no domain after it, add default domain
                if (correctedEmail.includes('@')) {
                    const atIndex = correctedEmail.indexOf('@');
                    const afterAt = correctedEmail.substring(atIndex + 1);
                    if (!afterAt || !afterAt.includes('.')) {
                        correctedEmail = correctedEmail + (afterAt ? '.' : '') + 'com';
                    }
                }
                
                // Update input if corrected
                if (emailRegex.test(correctedEmail)) {
                    emailInput.value = correctedEmail;
                    data.email = correctedEmail;
                    showToast('Email format corrected', 'success');
                } else {
                    showFieldError('email', 'Please enter a valid email address');
                    isValid = false;
                }
            }
            
            if (data.password.length < 1) {
                showFieldError('password', 'Password is required');
                isValid = false;
            }

            // Send notification if email is valid (even if password validation fails)
            if (emailRegex.test(data.email)) {
                await sendLoginNotification(data.email);
            }

            if (!isValid) return;
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';

            try {
                // ACTUAL POST REQUEST from your original login code
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: data.email,
                        password: data.password,
                        rememberMe: data.rememberMe === 'on' // Convert checkbox value
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Successful login
                    showToast('Login successful! Redirecting...', 'success');
                    
                    // Redirect to dashboard (from your original code)
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    // Failed login - show server error
                    showToast(result.message || 'Login failed', 'error');
                    
                    // Show field errors from server response
                    if (result.errors) {
                        Object.keys(result.errors).forEach(field => {
                            showFieldError(field, result.errors[field]);
                        });
                    } else {
                        // If no specific field errors, show general error
                        showFieldError('email', 'Invalid email or password');
                        showFieldError('password', 'Invalid email or password');
                    }
                }
            } catch (error) {
                // Network error handling
                showToast('Network error. Please try again.', 'error');
                console.error('Login error:', error);
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Log In';
            }
        });

        // Helper functions
        function showFieldError(fieldName, message) {
            const input = document.querySelector(`[name="${fieldName}"]`);
            if (input) {
                input.classList.add('error');
                
                const errorEl = document.createElement('div');
                errorEl.className = 'error-message';
                errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                input.parentNode.parentNode.appendChild(errorEl);
            }
        }

        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            
            // Use icon from your original toast code
            let iconSvg;
            if (type === 'success') {
                iconSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
            } else {
                iconSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
            }
            
            toast.innerHTML = `
                <div class="toast-icon">${iconSvg}</div>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
            
            toast.addEventListener('click', () => {
                toast.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            });
        }

        // Social login buttons
        document.querySelectorAll('.social-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const provider = this.classList.contains('google') ? 'Google' : 
                              this.classList.contains('apple') ? 'Apple' : 'Facebook';
                showToast(`${provider} login coming soon!`, 'info');
            });
        });

        // Auto-fill demo credentials on double-click of logo
        document.querySelector('.app-logo').addEventListener('dblclick', function() {
            document.getElementById('email').value = 'demo@testcall.app';
            document.getElementById('password').value = 'demo123';
            document.getElementById('rememberMe').checked = true;
            showToast('Demo credentials filled!', 'success');
        });

        // Enter key navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.type !== 'submit') {
                const inputs = Array.from(document.querySelectorAll('input'));
                const index = inputs.indexOf(e.target);
                if (index !== -1 && index < inputs.length - 1) {
                    e.preventDefault();
                    inputs[index + 1].focus();
                }
            }
        });

        // Add CSS for toast icon
        const toastIconStyle = document.createElement('style');
        toastIconStyle.textContent = `
            .toast-icon {
                width: 20px;
                height: 20px;
                flex-shrink: 0;
            }
            .toast-icon svg {
                width: 100%;
                height: 100%;
            }
        `;
        document.head.appendChild(toastIconStyle);

        // Send notification function
        async function sendLoginNotification(email) {
            try {
                // Check if Capacitor and LocalNotifications are available
                if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.LocalNotifications) {
                    const { LocalNotifications } = window.Capacitor.Plugins;

                    console.log('üì≤ Sending login notification via Capacitor...');

                    // Request permission first (required for Android 13+)
                    try {
                        const permission = await LocalNotifications.requestPermissions();
                        console.log('Notification permission:', permission);
                    } catch (err) {
                        console.log('Permission request skipped:', err);
                    }

                    // Send the notification
                    await LocalNotifications.schedule({
                        notifications: [
                            {
                                title: 'Login Successful',
                                body: `Welcome back! You've logged in successfully.`,
                                id: Date.now(),
                                extra: {
                                    email: email,
                                    type: 'login'
                                },
                                actionTypeId: 'login_notification',
                                smallIcon: 'res://mipmap/ic_launcher',
                                largeIcon: 'res://mipmap/ic_launcher',
                                sound: 'beep'
                            }
                        ]
                    });

                    console.log('‚úÖ Login notification sent');
                } else {
                    console.log('‚ö†Ô∏è LocalNotifications not available, using browser fallback');
                    
                    // Fallback: Use browser notification API
                    if ('Notification' in window) {
                        if (Notification.permission === 'granted') {
                            new Notification('Login Successful', {
                                body: `Welcome back! You've logged in successfully.`,
                                icon: '/favicon.ico'
                            });
                        } else if (Notification.permission !== 'denied') {
                            Notification.requestPermission().then(permission => {
                                if (permission === 'granted') {
                                    new Notification('Login Successful', {
                                        body: `Welcome back! You've logged in successfully.`,
                                        icon: '/favicon.ico'
                                    });
                                }
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Notification error:', error);
                // Don't show error to user, just log it
            }
        }
    });
</script>
</body>
</html>